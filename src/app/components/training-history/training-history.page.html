<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-menu-button></ion-menu-button>
    </ion-buttons>
    <ion-title>{{ 'TRAINING_HISTORY.TITLE' | translate }}</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <div class="history-container">
    @if (errorMessage) {
      <ion-text color="danger">
        <p class="error-message">{{ errorMessage | translate }}</p>
      </ion-text>
    }

    @if (loading) {
      <div class="loading-block">
        <ion-spinner name="crescent"></ion-spinner>
      </div>
    } @else if (trainings.length === 0) {
      <p class="empty-state">{{ 'TRAINING_HISTORY.EMPTY' | translate }}</p>
    } @else {
      @for (training of trainings; track training.id) {
        <ion-card>
          <ion-card-header>
            <ion-card-title>{{ training.routineNameSnapshot }}</ion-card-title>
            <ion-card-subtitle>
              {{ training.startedAt | date: 'dd/MM/yyyy HH:mm' }}
              @if (training.endedAt) {
                - {{ training.endedAt | date: 'dd/MM/yyyy HH:mm' }}
              }
            </ion-card-subtitle>
          </ion-card-header>
          <ion-card-content>
            @for (group of getGroupedSets(training); track group.exerciseName) {
              <div class="exercise-group">
                <div class="exercise-title-row">
                  <strong>{{ group.exerciseName }}</strong>
                  @if (group.photoUrl) {
                    <ion-button size="small" fill="clear" (click)="togglePhoto(training.id, group.exerciseName)">
                      {{ (isPhotoVisible(training.id, group.exerciseName) ? 'TRAINING_HISTORY.HIDE_PHOTO' : 'TRAINING_HISTORY.SHOW_PHOTO') | translate }}
                    </ion-button>
                  }
                </div>

                @if (group.photoUrl && isPhotoVisible(training.id, group.exerciseName)) {
                  <div class="photo-wrapper">
                    <img [src]="group.photoUrl" [alt]="group.exerciseName" />
                  </div>
                }

                <div class="sets-table">
                  @for (set of group.sets; track set.id) {
                    <div class="set-row">
                      <span>#{{ set.setNumber }}</span>
                      @if (set.exerciseTypeSnapshot === 'WEIGHT') {
                        <span>{{ set.weightKg ?? '-' }} kg</span>
                      }
                      @if (set.exerciseTypeSnapshot === 'DURATION' || set.exerciseTypeSnapshot === 'CHRONO') {
                        <span>{{ set.durationSec ?? '-' }} s</span>
                      }
                      @if (set.exerciseTypeSnapshot === 'DISTANCE_TIME') {
                        <span>{{ set.distanceMeters ?? '-' }} m / {{ set.durationSec ?? '-' }} s</span>
                      }
                    </div>
                  }
                </div>
              </div>
            }
          </ion-card-content>
        </ion-card>
      }
    }
  </div>
</ion-content>
